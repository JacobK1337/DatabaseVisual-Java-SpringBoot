<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Panel</title>
    <link th:href="@{css/styles.css}" rel="stylesheet" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300&family=Exo:wght@200&family=Lato:wght@300&family=Overpass:wght@200&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>

</head>
<body>
<input type="hidden" th:value="${databaseId}" id="databaseId">





<div id="panel-manage-div">
    <p>Table configuration</p>
    <table id="table-config-menu"></table>
</div>
<div id="usable-panel-area">
    <svg width="100%" height="100%" id="relationSvg"></svg>
</div>


<script>

    class Connection{
        constructor(constraintFieldId, linkedFieldId) {
            this.constraintFieldId = constraintFieldId;
            this.linkedFieldId = linkedFieldId;
        }
        get fieldId(){
            return this.constraintFieldId;
        }
        get linkFieldId(){
            return this.linkedFieldId;
        }
    }


    ///////////////////////////////////////
    const dbId = document.getElementById('databaseId').getAttribute('value');


    window.onload = async() =>{
        await drawAllTables(dbId);
        await drawAndSaveForeignKeys(dbId);
    }

    async function fetchForeignKeys(){
        let response = await fetch("/getForeignKeys?databaseId=" + dbId);
        return await response.json();
    }

    async function fetchTableDetails(databaseId){
        let response = await fetch("/tableDetails?databaseId=" + databaseId);
        return await response.json();
    }

    async function fetchTableFields(tableId){

        let response = await fetch("/getTableFields?tableId=" + tableId);
        return await response.json();

    }
    async function drawAllTables(databaseId){
        const tableDetails = await fetchTableDetails(databaseId);

        for(let i = 0; i < tableDetails.length; i++){
            let tableId = tableDetails[i][0];
            let tableName = tableDetails[i][1];
            let pageX = tableDetails[i][2];
            let pageY = tableDetails[i][3];

           await drawTable(pageX, pageY, tableName, tableId);
        }

    }

    let relationList = [];
    async function drawAndSaveForeignKeys(databaseId){
        const foreignKeys = await fetchForeignKeys(databaseId);

        for(let i = 0; i < foreignKeys.length; i++){

            const currentConnection = JSON.parse(foreignKeys[i]);
            const currentConnectionValues = Object.values(currentConnection);

            const constraintFieldId = currentConnectionValues[0];
            const linkedFieldId = currentConnectionValues[1];
            const fieldName = currentConnectionValues[2];

            relationList.push(new Connection(constraintFieldId, linkedFieldId));

            const newLine = document.createElementNS('http://www.w3.org/2000/svg','line');

            newLine.setAttribute('stroke', 'red');
            newLine.setAttribute('visibility', 'visible');
            newLine.setAttribute('stroke-width', '2');
            newLine.id = constraintFieldId + '-' + linkedFieldId;

            const newLineLabel = document.createElementNS('http://www.w3.org/2000/svg','text');
            newLineLabel.appendChild(document.createTextNode(fieldName));

            newLineLabel.id = 'label--' + newLine.id;

            document.getElementById('relationSvg').appendChild(newLineLabel);
            document.getElementById('relationSvg').appendChild(newLine);
        }

        redrawRelations(relationList);

    }

    async function drawTable(x, y, name, tabId){
        let newTable = document.createElement('div');
        newTable.classList.add('table');
        newTable.style.top = y + 'px';
        newTable.style.left = x + 'px';
        newTable.id = tabId;
        newTable.insertAdjacentHTML('beforeend', "<p>" + name + "</p>");

        const tableFields = await fetchTableFields(tabId);

        for(let i = 0; i < tableFields.length ;i++){
            const tableFieldElement = document.createElement('p');
            tableFieldElement.appendChild(document.createTextNode(tableFields[i][1] + ": " + tableFields[i][2]));

            tableFieldElement.id = 'tf' + tableFields[i][0];
            newTable.appendChild(tableFieldElement);
        }

        const lineBreak = document.createElement('br');

        let configButton = initConfigButton(tabId);
        let deleteButton = initDeleteButton(tabId);

        newTable.appendChild(configButton);
        newTable.appendChild(lineBreak);

        newTable.appendChild(deleteButton);
        newTable.appendChild(lineBreak);


        document.getElementById('usable-panel-area').appendChild(newTable);
        //document.body.appendChild(newTable);

        //functions updates tables menu by adding current table options
        //updateTableManageMenu(tabId, name);

        //make the table draggable ;)
        const currentTable = $('#' + tabId);
        currentTable.appendTo("body");
        currentTable.draggable({
            containment: '#usable-panel-area',
            drag: () =>{
                redrawRelations(relationList);
            },
            stop: (event, ui) =>{
                let tableId = event.target.id;
                let newTop = event.target.style.top;
                let newLeft = event.target.style.left;
                saveTableLocation(tableId, newTop, newLeft);
            }

        });

    }

    function initConfigButton(tableId){

        let configButton = document.createElement('button');
        configButton.textContent = 'Manage table';
        configButton.classList.toggle('config-table-button');
        configButton.addEventListener('click', () =>{
            window.open('http://localhost:8080/manage_data?tableId=' + tableId, 'Manage data window');
        });

        return configButton;
    }

    function initDeleteButton(tableId){

        let deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete table';
        deleteButton.classList.toggle('delete-table-button');

        deleteButton.addEventListener('click', () =>{

            $.ajax({
               type: 'post',
                url: '/deleteTable',
                data:{
                   'tableId' : tableId
                },
                success: () =>{

                }
            });
        });

        return deleteButton;
    }

    function saveTableLocation(tableId, top, left) {

        const newTop = top.substring(0, top.length - 2);
        const newLeft = left.substring(0, left.length - 2);

        $.ajax({
            type: 'post',
            url: '/updatePlacement',
            data: {
                'tableId': tableId,
                'pageX': newLeft,
                'pageY': newTop
            },

        });

    }

    function redrawRelations(relList){
        for(let i = 0; i < relList.length; i++){
            const constraintFieldId = relList[i].fieldId;
            const linkedFieldId = relList[i].linkFieldId;

            const fieldOne = $('#tf' + constraintFieldId).parent('.table');
            const fieldTwo = $('#tf' + linkedFieldId).parent('.table');

            const currentLine = document.getElementById(constraintFieldId + '-' + linkedFieldId);
            const currentLineLabel = document.getElementById('label--' + currentLine.id);
            const fOx1 = fieldOne.offset().left + fieldOne.width()/2;
            const fOy1 = fieldOne.offset().top; //- fieldOne.height()/2;

            const fOx2 = fieldTwo.offset().left  + fieldTwo.width()/2;
            const fOy2 = fieldTwo.offset().top;  //- fieldTwo.height()/2;

            $(currentLine)
                .attr('x1', fOx1)
                .attr('y1', fOy1)
                .attr('x2', fOx2)
                .attr('y2', fOy2);

            $(currentLineLabel)
                .attr('x', (fOx1 + fOx2)/2)
                .attr('y', (fOy1 + fOy2)/2);

        }
    }

    document.addEventListener('click', (e) =>{
        if(e.target.className === 'table-manage-button'
            || e.target.className === 'data-manage-button'
            || e.target.classList.contains('table-content--active')){

            const nextElement = e.target.nextElementSibling;
            e.target.classList.toggle('table-content--active');
            if(e.target.classList.contains('table-content--active')){
                nextElement.style.maxHeight = nextElement.scrollHeight + 'px';

            }
            else{
                nextElement.style.maxHeight = 0 + 'px';
            }
        }
    });

</script>
</body>
</html>